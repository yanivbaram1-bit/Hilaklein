import React, { useState } from 'react';
import { Search, ExternalLink, Car, Wrench, ShieldCheck } from 'lucide-react';

const RealPartsFinder = () => {
  const [plate, setPlate] = useState('');
  const [carData, setCarData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const fetchCarDetails = async () => {
    if (!plate) return;
    setLoading(true);
    setError('');
    setCarData(null);

    try {
      // פנייה למאגר הרכב הממשלתי של ישראל (Open Data)
      const resourceId = '053ad243-5e8b-4474-8c27-40e4ee9067b0';
      const response = await fetch(
        `https://data.gov.il/api/3/action/datastore_search?resource_id=${resourceId}&q=${plate}`
      );
      const data = await response.json();
      const record = data.result.records.find(r => String(r.mispar_rechev) === plate);

      if (record) {
        setCarData({
          plate: record.mispar_rechev,
          vin: record.deg_deg, // מספר שלדה
          make: record.tozeret_nm, // יצרן
          model: record.kinuy_mishari, // דגם
          year: record.shnat_yitzur, // שנה
          engine: record.deg_manua // דגם מנוע
        });
      } else {
        setError('רכב לא נמצא במאגר. בדוק את המספר.');
      }
    } catch (err) {
      setError('שגיאה בחיבור למאגר הנתונים.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-6 bg-gray-50 min-h-screen font-sans" dir="rtl">
      <header className="text-center mb-10">
        <h1 className="text-3xl font-bold text-blue-900 flex items-center justify-center gap-3">
          <Wrench size={32} /> מערכת איתור מק"טים מקצועית
        </h1>
        <p className="text-gray-600 mt-2">הכנס מספר רכב לשליפת שלדה וקישור לקטלוגים</p>
      </header>

      {/* אזור החיפוש */}
      <div className="bg-white p-6 rounded-2xl shadow-lg mb-8 flex gap-4 border-2 border-blue-100">
        <input
          type="number"
          placeholder="מספר רכב (למשל 12345678)"
          className="flex-1 p-4 border rounded-xl text-2xl font-bold tracking-[5px] text-center focus:ring-2 focus:ring-blue-500 outline-none"
          value={plate}
          onChange={(e) => setPlate(e.target.value)}
        />
        <button
          onClick={fetchCarDetails}
          disabled={loading}
          className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold hover:bg-blue-700 transition flex items-center gap-2"
        >
          {loading ? "מושך נתונים..." : <><Search size={24} /> שלוף שלדה</>}
        </button>
      </div>

      {error && <div className="bg-red-100 text-red-700 p-4 rounded-lg mb-6 text-center font-bold">{error}</div>}

      {/* תוצאות וקישורים */}
      {carData && (
        <div className="space-y-6 animate-in fade-in duration-500">
          <div className="bg-white p-6 rounded-2xl shadow-md border-r-8 border-green-500">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-gray-800">
              <Car className="text-green-600" /> פרטי רכב מזוהים
            </h2>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div><span className="text-gray-500">יצרן:</span> <p className="font-bold">{carData.make}</p></div>
              <div><span className="text-gray-500">דגם:</span> <p className="font-bold">{carData.model}</p></div>
              <div><span className="text-gray-500">שנה:</span> <p className="font-bold">{carData.year}</p></div>
              <div><span className="text-gray-500">קוד מנוע:</span> <p className="font-bold font-mono">{carData.engine}</p></div>
            </div>
            <div className="mt-6 p-4 bg-gray-100 rounded-lg flex justify-between items-center">
              <div>
                <span className="text-xs text-gray-500 block uppercase">מספר שלדה (VIN)</span>
                <span className="text-lg font-mono font-bold tracking-wider">{carData.vin}</span>
              </div>
              <button 
                onClick={() => navigator.clipboard.writeText(carData.vin)}
                className="text-blue-600 text-sm hover:underline"
              >העתק מספר שלדה</button>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* כפתור לקטלוג Partsouq */}
            <a 
              href={`https://partsouq.com/en/catalog/genuine/locate?vin=${carData.vin}`} 
              target="_blank" 
              className="flex items-center justify-between p-6 bg-orange-50 border border-orange-200 rounded-2xl hover:shadow-lg transition group"
            >
              <div>
                <h3 className="font-bold text-orange-900 text-lg">קטלוג Partsouq</h3>
                <p className="text-sm text-orange-700">מעולה ליפניות, קוריאניות ודיאגרמות</p>
              </div>
              <ExternalLink className="text-orange-400 group-hover:translate-x-[-5px] transition" />
            </a>

            {/* כפתור לקטלוג 7Zap */}
            <a 
              href={`https://7zap.com/en/catalog/cars/vin/${carData.vin}`} 
              target="_blank" 
              className="flex items-center justify-between p-6 bg-blue-50 border border-blue-200 rounded-2xl hover:shadow-lg transition group"
            >
              <div>
                <h3 className="font-bold text-blue-900 text-lg">קטלוג 7Zap</h3>
                <p className="text-sm text-blue-700">מומלץ לאירופאיות (VAG, BMW, וכו')</p>
              </div>
              <ExternalLink className="text-blue-400 group-hover:translate-x-[-5px] transition" />
            </a>
          </div>
        </div>
      )}
    </div>
  );
};

export default RealPartsFinder;
